#include <complex>
#include <ap_int.h>

#define IN_SIZE 	64
#define OUT_SIZE 	122	//2*ceil(1.8941538461538463*IN_SIZE/2)
#define TRANSIENT	18 	//Overlap/discard length of output filter arm's transient

#define RRC_NTAPS 	299
#define FILTER_SIZE	16
#define INTERP		1.894153846153846298960843341774307191371917724609375
#define FLT_RATE	FILTER_SIZE/INTERP // residual rate for the linear interpolation
#define ARMS		32
#define TAPS		19

struct axis_float {
	float data;
    ap_uint<1> last;
};

// Arbitrary resampler filterbank
static const float d_filters[ARMS][TAPS] = \
{
	{-0.00046886742347851396,0.00041674260864965618,-0.00015250233991537243,-0.00043477260624058545,0.00146092928480356932,-0.00306701892986893654,0.00553486635908484459,-0.00986365135759115219,0.02337807230651378632,0.04204995930194854736,-0.00639031967148184776,0.00119522865861654282,0.00079280440695583820,-0.00158283137716352940,0.00174356286879628897,-0.00156123249325901270,0.00122625171206891537,-0.00087009201524779201,0.00057239673333242536},
	{-0.00034216098720207810,0.00022593094035983086,0.00011257109872531146,-0.00076780689414590597,0.00182787270750850439,-0.00338932476006448269,0.00564929330721497536,-0.00934950914233922958,0.01973867788910865784,0.04411834478378295898,-0.00458599068224430084,-0.00002143628444173373,0.00160355388652533293,-0.00209100102074444294,0.00202714232727885246,-0.00168824126012623310,0.00125537603162229061,-0.00084784039063379169,0.00053110171575099230},
	{-0.00020955537911504507,0.00003558871321729384,0.00036386010469868779,-0.00106444256380200386,0.00212464947253465652,-0.00359535007737576962,0.00558867538347840309,-0.00859718117862939835,0.01610863395035266876,0.04576805606484413147,-0.00243677268736064434,-0.00131505355238914490,0.00240330793894827366,-0.00255468091927468777,0.00225755455903708935,-0.00176592264324426651,0.00124453043099492788,-0.00079610972898080945,0.00046942124026827514},
	{-0.00007564402767457068,-0.00014822289813309908,0.00059402600163593888,-0.00131692050490528345,0.00234498502686619759,-0.00368389650247991085,0.00536374095827341080,-0.00764446333050727844,0.01254694163799285889,0.04696872085332870483,0.00003797296085394919,-0.00265149516053497791,0.00316677475348114967,-0.00295745115727186203,0.00242538284510374069,-0.00178985297679901123,0.00119248684495687485,-0.00071543565718457103,0.00038864865200594068},
	{0.00005511023846338503,-0.00031987740658223629,0.00079666060628369451,-0.00151912379078567028,0.00248515070416033268,-0.00365728279575705528,0.00498934462666511536,-0.00653166510164737701,0.00910966191440820694,0.04769813641905784607,0.00281124678440392017,-0.00399331422522664070,0.00386855145916342735,-0.00328409927897155285,0.00252282177098095417,-0.00175716681405901909,0.00109932036139070988,-0.00060734624275937676,0.00029078923398628831},
	{0.00017851754091680050,-0.00047434779116883874,0.00096645357552915812,-0.00166670710314065218,0.00254398258402943611,-0.00352113717235624790,0.00448386836796998978,-0.00530055584385991096,0.00584879331290721893,0.04794279113411903381,0.00584879331290721893,-0.00530055584385991096,0.00448386836796998978,-0.00352113717235624790,0.00254398258402943611,-0.00166670710314065218,0.00096645357552915812,-0.00047434779116883874,0.00017851754091680050},
	{0.00029078923398628831,-0.00060734624275937676,0.00109932036139070988,-0.00175716681405901909,0.00252282177098095417,-0.00328409927897155285,0.00386855145916342735,-0.00399331422522664070,0.00281124678440392017,0.04769813641905784607,0.00910966191440820694,-0.00653166510164737701,0.00498934462666511536,-0.00365728279575705528,0.00248515070416033268,-0.00151912379078567028,0.00079666060628369451,-0.00031987740658223629,0.00005511023846338503},
	{0.00038864865200594068,-0.00071543565718457103,0.00119248684495687485,-0.00178985297679901123,0.00242538284510374069,-0.00295745115727186203,0.00316677475348114967,-0.00265149516053497791,0.00003797296085394919,0.04696872085332870483,0.01254694163799285889,-0.00764446333050727844,0.00536374095827341080,-0.00368389650247991085,0.00234498502686619759,-0.00131692050490528345,0.00059402600163593888,-0.00014822289813309908,-0.00007564402767457068},
	{0.00046942124026827514,-0.00079610972898080945,0.00124453043099492788,-0.00176592264324426651,0.00225755455903708935,-0.00255468091927468777,0.00240330793894827366,-0.00131505355238914490,-0.00243677268736064434,0.04576805606484413147,0.01610863395035266876,-0.00859718117862939835,0.00558867538347840309,-0.00359535007737576962,0.00212464947253465652,-0.00106444256380200386,0.00036386010469868779,0.00003558871321729384,-0.00020955537911504507},
	{0.00053110171575099230,-0.00084784039063379169,0.00125537603162229061,-0.00168824126012623310,0.00202714232727885246,-0.00209100102074444294,0.00160355388652533293,-0.00002143628444173373,-0.00458599068224430084,0.04411834478378295898,0.01973867788910865784,-0.00934950914233922958,0.00564929330721497536,-0.00338932476006448269,0.00182787270750850439,-0.00076780689414590597,0.00011257109872531146,0.00022593094035983086,-0.00034216098720207810},
	{0.00057239673333242536,-0.00087009201524779201,0.00122625171206891537,-0.00156123249325901270,0.00174356286879628897,-0.00158283137716352940,0.00079280440695583820,0.00119522865861654282,-0.00639031967148184776,0.04204995930194854736,0.02337807230651378632,-0.00986365135759115219,0.00553486635908484459,-0.00306701892986893654,0.00146092928480356932,-0.00043477260624058545,-0.00015250233991537243,0.00041674260864965618,-0.00046886742347851396},
	{0.00000000000000000000,-0.00086330337217077613,0.00115960265975445509,-0.00139068590942770243,0.00141750078182667494,-0.00104726885911077261,-0.00000447181537310826,0.00230483245104551315,-0.00783823616802692413,0.03960079327225685120,0.02696608193218708038,-0.01010535378009080887,0.00523929949849843979,-0.00263325776904821396,0.00103254290297627449,-0.00007455481681972742,-0.00042329516145400703,0.00060171284712851048,-0.00058510212693363428},
	{0.00000000000000000000,-0.00082883832510560751,0.00105897104367613792,-0.00118353043217211962,0.00106053764466196299,-0.00050155509961768985,-0.00076528929639607668,0.00328185758553445339,-0.00892606936395168304,0.03681540116667747498,0.03044152073562145233,-0.01004486531019210815,0.00476153194904327393,-0.00209650048054754734,0.00055370887275785208,0.00030241365311667323,-0.00069125049049034715,0.00077448092633858323,-0.00068646972067654133},
	{0.00000000000000000000,-0.00076890812488272786,0.00092884461628273129,-0.00094757816987112164,0.00068476813612505794,0.00003744073910638690,-0.00146873923949897289,0.00410581473261117935,-0.00965782906860113144,0.03374403342604637146,0.03374403342604637146,-0.00965782906860113144,0.00410581473261117935,-0.00146873923949897289,0.00003744073910638690,0.00068476813612505794,-0.00094757816987112164,0.00092884461628273129,-0.00076890812488272786},
	{0.00000000000000000000,-0.00068646972067654133,0.00077448092633858323,-0.00069125049049034715,0.00030241365311667323,0.00055370887275785208,-0.00209650048054754734,0.00476153194904327393,-0.01004486531019210815,0.03044152073562145233,0.03681540116667747498,-0.00892606936395168304,0.00328185758553445339,-0.00076528929639607668,-0.00050155509961768985,0.00106053764466196299,-0.00118353043217211962,0.00105897104367613792,-0.00082883832510560751},
	{0.00000000000000000000,-0.00058510212693363428,0.00060171284712851048,-0.00042329516145400703,-0.00007455481681972742,0.00103254290297627449,-0.00263325776904821396,0.00523929949849843979,-0.01010535378009080887,0.02696608193218708038,0.03960079327225685120,-0.00783823616802692413,0.00230483245104551315,-0.00000447181537310826,-0.00104726885911077261,0.00141750078182667494,-0.00139068590942770243,0.00115960265975445509,-0.00086330337217077613},
	{0.00012670643627643585,-0.00019081166828982532,0.00026507343864068389,-0.00033303428790532053,0.00036694342270493507,-0.00032230583019554615,0.00011442694813013077,0.00051414221525192261,-0.00363939441740512848,0.00206838548183441162,0.00180432898923754692,-0.00121666491031646729,0.00081074947956949472,-0.00050816964358091354,0.00028357945848256350,-0.00012700876686722040,0.00002912431955337524,0.00002225162461400032,-0.00004129501758143306},
	{0.00013260560808703303,-0.00019034222350455821,0.00025128899142146111,-0.00029663566965609789,0.00029677676502615213,-0.00020602531731128693,-0.00006061792373657227,0.00075232796370983124,-0.00363004393875598907,0.00164971128106117249,0.00214921799488365650,-0.00129361730068922043,0.00079975405242294073,-0.00046367989853024483,0.00023041223175823689,-0.00007768138311803341,-0.00001084560062736273,0.00005173066165298223,-0.00006168047548271716},
	{0.00013391135144047439,-0.00018381161498837173,0.00023016589693725109,-0.00025247794110327959,0.00022033555433154106,-0.00008854642510414124,-0.00022493442520499229,0.00095271784812211990,-0.00356169231235980988,0.00120066478848457336,0.00247474573552608490,-0.00133644160814583302,0.00076346681453287601,-0.00040277023799717426,0.00016782828606665134,-0.00002393033355474472,-0.00005204358603805304,0.00008067407179623842,-0.00008077258826233447},
	{0.00013075426977593452,-0.00017165450844913721,0.00020263460464775562,-0.00020220328588038683,0.00014016567729413509,0.00002661370672285557,-0.00037439633160829544,0.00111279822885990143,-0.00343727972358465195,0.00072941556572914124,0.00277327373623847961,-0.00134181906469166279,0.00070177670568227768,-0.00032664812169969082,0.00009743892587721348,0.00003268616273999214,-0.00009316648356616497,0.00010808941442519426,-0.00009785941801965237},
	{0.00012340729881543666,-0.00015447038458660245,0.00016979296924546361,-0.00014758331235498190,0.00005883187986910343,0.00013614562340080738,-0.00050547625869512558,0.00123110925778746605,-0.00326086860150098801,0.00024465471506118774,0.00303754652850329876,-0.00130724161863327026,0.00061531690880656242,-0.00023703789338469505,0.00002116081304848194,0.00009045971091836691,-0.00013286678586155176,0.00013299845159053802,-0.00011227169306948781},
	{0.00011227169306948781,-0.00013299845159053802,0.00013286678586155176,-0.00009045971091836691,-0.00002116081304848194,0.00023703789338469505,-0.00061531690880656242,0.00130724161863327026,-0.00303754652850329876,-0.00024465471506118774,0.00326086860150098801,-0.00123110925778746605,0.00050547625869512558,-0.00013614562340080738,-0.00005883187986910343,0.00014758331235498190,-0.00016979296924546361,0.00015447038458660245,-0.00012340729881543666},
	{0.00009785941801965237,-0.00010808941442519426,0.00009316648356616497,-0.00003268616273999214,-0.00009743892587721348,0.00032664812169969082,-0.00070177670568227768,0.00134181906469166279,-0.00277327373623847961,-0.00072941556572914124,0.00343727972358465195,-0.00111279822885990143,0.00037439633160829544,-0.00002661370672285557,-0.00014016567729413509,0.00020220328588038683,-0.00020263460464775562,0.00017165450844913721,-0.00013075426977593452},
	{0.00008077258826233447,-0.00008067407179623842,0.00005204358603805304,0.00002393033355474472,-0.00016782828606665134,0.00040277023799717426,-0.00076346681453287601,0.00133644160814583302,-0.00247474573552608490,-0.00120066478848457336,0.00356169231235980988,-0.00095271784812211990,0.00022493442520499229,0.00008854642510414124,-0.00022033555433154106,0.00025247794110327959,-0.00023016589693725109,0.00018381161498837173,-0.00013391135144047439},
	{0.00006168047548271716,-0.00005173066165298223,0.00001084560062736273,0.00007768138311803341,-0.00023041223175823689,0.00046367989853024483,-0.00079975405242294073,0.00129361730068922043,-0.00214921799488365650,-0.00164971128106117249,0.00363004393875598907,-0.00075232796370983124,0.00006061792373657227,0.00020602531731128693,-0.00029677676502615213,0.00029663566965609789,-0.00025128899142146111,0.00019034222350455821,-0.00013260560808703303},
	{0.00004129501758143306,-0.00002225162461400032,-0.00002912431955337524,0.00012700876686722040,-0.00028357945848256350,0.00050816964358091354,-0.00081074947956949472,0.00121666491031646729,-0.00180432898923754692,-0.00206838548183441162,0.00363939441740512848,-0.00051414221525192261,-0.00011442694813013077,0.00032230583019554615,-0.00036694342270493507,0.00033303428790532053,-0.00026507343864068389,0.00019081166828982532,-0.00012670643627643585},
	{0.00000000000000000000,0.00000678864307701588,-0.00006664905231446028,0.00017054658383131027,-0.00032606208696961403,0.00053556251805275679,-0.00079727621050551534,0.00110960379242897034,-0.00144791649654507637,-0.00244916602969169617,0.00358800962567329407,-0.00024170242249965668,-0.00029556686058640480,0.00043376116082072258,-0.00042838638182729483,0.00036021778942085803,-0.00027079280698671937,0.00018497023847885430,-0.00011623470345512033},
	{0.00000000000000000000,0.00003446504706516862,-0.00010063161607831717,0.00020715547725558281,-0.00035696313716471195,0.00054571375949308276,-0.00076081749284639955,0.00097702513448894024,-0.00108783319592475891,-0.00278539210557937622,0.00347543880343437195,0.00006048846989870071,-0.00047776754945516586,0.00053675728850066662,-0.00047883403021842241,0.00037696846993640065,-0.00026795532903634012,0.00017276807921007276,-0.00010136759374290705},
	{0.00000000000000000000,0.00005993020022287965,-0.00013012642739340663,0.00023595226230099797,-0.00037576950853690505,0.00053899583872407675,-0.00070344994310289621,0.00082395714707672596,-0.00073175970464944839,-0.00307136774063110352,0.00330251269042491913,0.00038703624159097672,-0.00065571721643209457,0.00062776124104857445,-0.00051626813365146518,0.00038235448300838470,-0.00025632767938077450,0.00015436368994414806,-0.00008243840420618653},
	{0.00000000000000000000,0.00008243840420618653,-0.00015436368994414806,0.00025632767938077450,-0.00038235448300838470,0.00051626813365146518,-0.00062776124104857445,0.00065571721643209457,-0.00038703624159097672,-0.00330251269042491913,0.00307136774063110352,0.00073175970464944839,-0.00082395714707672596,0.00070344994310289621,-0.00053899583872407675,0.00037576950853690505,-0.00023595226230099797,0.00013012642739340663,-0.00005993020022287965},
	{0.00000000000000000000,0.00010136759374290705,-0.00017276807921007276,0.00026795532903634012,-0.00037696846993640065,0.00047883403021842241,-0.00053675728850066662,0.00047776754945516586,-0.00006048846989870071,-0.00347543880343437195,0.00278539210557937622,0.00108783319592475891,-0.00097702513448894024,0.00076081749284639955,-0.00054571375949308276,0.00035696313716471195,-0.00020715547725558281,0.00010063161607831717,-0.00003446504706516862},
	{0.00000000000000000000,0.00011623470345512033,-0.00018497023847885430,0.00027079280698671937,-0.00036021778942085803,0.00042838638182729483,-0.00043376116082072258,0.00029556686058640480,0.00024170242249965668,-0.00358800962567329407,0.00244916602969169617,0.00144791649654507637,-0.00110960379242897034,0.00079727621050551534,-0.00053556251805275679,0.00032606208696961403,-0.00017054658383131027,0.00006664905231446028,-0.00000678864307701588}
};

// Differential filterbank
static const float d_diff_filters[FILTER_SIZE][TAPS] = \
{
	{0.00012670643627643585,-0.00019081166828982532,0.00026507343864068389,-0.00033303428790532053,0.00036694342270493507,-0.00032230583019554615,0.00011442694813013077,0.00051414221525192261,-0.00363939441740512848,0.00206838548183441162,0.00180432898923754692,-0.00121666491031646729,0.00081074947956949472,-0.00050816964358091354,0.00028357945848256350,-0.00012700876686722040,0.00002912431955337524,0.00002225162461400032,-0.00004129501758143306},
	{0.00013260560808703303,-0.00019034222350455821,0.00025128899142146111,-0.00029663566965609789,0.00029677676502615213,-0.00020602531731128693,-0.00006061792373657227,0.00075232796370983124,-0.00363004393875598907,0.00164971128106117249,0.00214921799488365650,-0.00129361730068922043,0.00079975405242294073,-0.00046367989853024483,0.00023041223175823689,-0.00007768138311803341,-0.00001084560062736273,0.00005173066165298223,-0.00006168047548271716},
	{0.00013391135144047439,-0.00018381161498837173,0.00023016589693725109,-0.00025247794110327959,0.00022033555433154106,-0.00008854642510414124,-0.00022493442520499229,0.00095271784812211990,-0.00356169231235980988,0.00120066478848457336,0.00247474573552608490,-0.00133644160814583302,0.00076346681453287601,-0.00040277023799717426,0.00016782828606665134,-0.00002393033355474472,-0.00005204358603805304,0.00008067407179623842,-0.00008077258826233447},
	{0.00013075426977593452,-0.00017165450844913721,0.00020263460464775562,-0.00020220328588038683,0.00014016567729413509,0.00002661370672285557,-0.00037439633160829544,0.00111279822885990143,-0.00343727972358465195,0.00072941556572914124,0.00277327373623847961,-0.00134181906469166279,0.00070177670568227768,-0.00032664812169969082,0.00009743892587721348,0.00003268616273999214,-0.00009316648356616497,0.00010808941442519426,-0.00009785941801965237},
	{0.00012340729881543666,-0.00015447038458660245,0.00016979296924546361,-0.00014758331235498190,0.00005883187986910343,0.00013614562340080738,-0.00050547625869512558,0.00123110925778746605,-0.00326086860150098801,0.00024465471506118774,0.00303754652850329876,-0.00130724161863327026,0.00061531690880656242,-0.00023703789338469505,0.00002116081304848194,0.00009045971091836691,-0.00013286678586155176,0.00013299845159053802,-0.00011227169306948781},
	{0.00011227169306948781,-0.00013299845159053802,0.00013286678586155176,-0.00009045971091836691,-0.00002116081304848194,0.00023703789338469505,-0.00061531690880656242,0.00130724161863327026,-0.00303754652850329876,-0.00024465471506118774,0.00326086860150098801,-0.00123110925778746605,0.00050547625869512558,-0.00013614562340080738,-0.00005883187986910343,0.00014758331235498190,-0.00016979296924546361,0.00015447038458660245,-0.00012340729881543666},
	{0.00009785941801965237,-0.00010808941442519426,0.00009316648356616497,-0.00003268616273999214,-0.00009743892587721348,0.00032664812169969082,-0.00070177670568227768,0.00134181906469166279,-0.00277327373623847961,-0.00072941556572914124,0.00343727972358465195,-0.00111279822885990143,0.00037439633160829544,-0.00002661370672285557,-0.00014016567729413509,0.00020220328588038683,-0.00020263460464775562,0.00017165450844913721,-0.00013075426977593452},
	{0.00008077258826233447,-0.00008067407179623842,0.00005204358603805304,0.00002393033355474472,-0.00016782828606665134,0.00040277023799717426,-0.00076346681453287601,0.00133644160814583302,-0.00247474573552608490,-0.00120066478848457336,0.00356169231235980988,-0.00095271784812211990,0.00022493442520499229,0.00008854642510414124,-0.00022033555433154106,0.00025247794110327959,-0.00023016589693725109,0.00018381161498837173,-0.00013391135144047439},
	{0.00006168047548271716,-0.00005173066165298223,0.00001084560062736273,0.00007768138311803341,-0.00023041223175823689,0.00046367989853024483,-0.00079975405242294073,0.00129361730068922043,-0.00214921799488365650,-0.00164971128106117249,0.00363004393875598907,-0.00075232796370983124,0.00006061792373657227,0.00020602531731128693,-0.00029677676502615213,0.00029663566965609789,-0.00025128899142146111,0.00019034222350455821,-0.00013260560808703303},
	{0.00004129501758143306,-0.00002225162461400032,-0.00002912431955337524,0.00012700876686722040,-0.00028357945848256350,0.00050816964358091354,-0.00081074947956949472,0.00121666491031646729,-0.00180432898923754692,-0.00206838548183441162,0.00363939441740512848,-0.00051414221525192261,-0.00011442694813013077,0.00032230583019554615,-0.00036694342270493507,0.00033303428790532053,-0.00026507343864068389,0.00019081166828982532,-0.00012670643627643585},
	{0.00000000000000000000,0.00000678864307701588,-0.00006664905231446028,0.00017054658383131027,-0.00032606208696961403,0.00053556251805275679,-0.00079727621050551534,0.00110960379242897034,-0.00144791649654507637,-0.00244916602969169617,0.00358800962567329407,-0.00024170242249965668,-0.00029556686058640480,0.00043376116082072258,-0.00042838638182729483,0.00036021778942085803,-0.00027079280698671937,0.00018497023847885430,-0.00011623470345512033},
	{0.00000000000000000000,0.00003446504706516862,-0.00010063161607831717,0.00020715547725558281,-0.00035696313716471195,0.00054571375949308276,-0.00076081749284639955,0.00097702513448894024,-0.00108783319592475891,-0.00278539210557937622,0.00347543880343437195,0.00006048846989870071,-0.00047776754945516586,0.00053675728850066662,-0.00047883403021842241,0.00037696846993640065,-0.00026795532903634012,0.00017276807921007276,-0.00010136759374290705},
	{0.00000000000000000000,0.00005993020022287965,-0.00013012642739340663,0.00023595226230099797,-0.00037576950853690505,0.00053899583872407675,-0.00070344994310289621,0.00082395714707672596,-0.00073175970464944839,-0.00307136774063110352,0.00330251269042491913,0.00038703624159097672,-0.00065571721643209457,0.00062776124104857445,-0.00051626813365146518,0.00038235448300838470,-0.00025632767938077450,0.00015436368994414806,-0.00008243840420618653},
	{0.00000000000000000000,0.00008243840420618653,-0.00015436368994414806,0.00025632767938077450,-0.00038235448300838470,0.00051626813365146518,-0.00062776124104857445,0.00065571721643209457,-0.00038703624159097672,-0.00330251269042491913,0.00307136774063110352,0.00073175970464944839,-0.00082395714707672596,0.00070344994310289621,-0.00053899583872407675,0.00037576950853690505,-0.00023595226230099797,0.00013012642739340663,-0.00005993020022287965},
	{0.00000000000000000000,0.00010136759374290705,-0.00017276807921007276,0.00026795532903634012,-0.00037696846993640065,0.00047883403021842241,-0.00053675728850066662,0.00047776754945516586,-0.00006048846989870071,-0.00347543880343437195,0.00278539210557937622,0.00108783319592475891,-0.00097702513448894024,0.00076081749284639955,-0.00054571375949308276,0.00035696313716471195,-0.00020715547725558281,0.00010063161607831717,-0.00003446504706516862},
	{0.00000000000000000000,0.00011623470345512033,-0.00018497023847885430,0.00027079280698671937,-0.00036021778942085803,0.00042838638182729483,-0.00043376116082072258,0.00029556686058640480,0.00024170242249965668,-0.00358800962567329407,0.00244916602969169617,0.00144791649654507637,-0.00110960379242897034,0.00079727621050551534,-0.00053556251805275679,0.00032606208696961403,-0.00017054658383131027,0.00006664905231446028,-0.00000678864307701588}
};

void atsc_rx_filter(axis_float in[IN_SIZE], axis_float out[OUT_SIZE]);

/*!
* \brief Polyphase filterbank arbitrary resampler with
*        complex input, complex output and float taps
* \ingroup resamplers_blk
*
* \details
* This  takes in a signal stream and performs arbitrary
* resampling. The resampling rate can be any real number
* <EM>r</EM>. The resampling is done by constructing <EM>N</EM>
* filters where <EM>N</EM> is the interpolation rate.  We then
* calculate <EM>D</EM> where <EM>D = floor(N/r)</EM>.
*
* Using <EM>N</EM> and <EM>D</EM>, we can perform rational
* resampling where <EM>N/D</EM> is a rational number close to
* the input rate <EM>r</EM> where we have <EM>N</EM> filters
* and we cycle through them as a polyphase filterbank with a
* stride of <EM>D</EM> so that <EM>i+1 = (i + D) % N</EM>.
*
* To get the arbitrary rate, we want to interpolate between two
* points. For each value out, we take an output from the
* current filter, <EM>i</EM>, and the next filter <EM>i+1</EM>
* and then linearly interpolate between the two based on the
* real resampling rate we want.
*
* The linear interpolation only provides us with an
* approximation to the real sampling rate specified. The error
* is a quantization error between the two filters we used as
* our interpolation points.  To this end, the number of
* filters, <EM>N</EM>, used determines the quantization error;
* the larger <EM>N</EM>, the smaller the noise. You can design
* for a specified noise floor by setting the filter size
* (parameters <EM>filter_size</EM>). The size defaults to 32
* filters, which is about as good as most implementations need.
*
* The trick with designing this filter is in how to specify the
* taps of the prototype filter. Like the PFB interpolator, the
* taps are specified using the interpolated filter rate. In
* this case, that rate is the input sample rate multiplied by
* the number of filters in the filterbank, which is also the
* interpolation rate. All other values should be relative to
* this rate.
*
* For example, for a 32-filter arbitrary resampler and using
* the GNU Radio's firdes utility to build the filter, we build
* a low-pass filter with a sampling rate of <EM>fs</EM>, a 3-dB
* bandwidth of <EM>BW</EM> and a transition bandwidth of
* <EM>TB</EM>. We can also specify the out-of-band attenuation
* to use, <EM>ATT</EM>, and the filter window function (a
* Blackman-harris window in this case). The first input is the
* gain of the filter, which we specify here as the
* interpolation rate (<EM>32</EM>).
*
*   <B><EM>self._taps = filter.firdes.low_pass_2(32, 32*fs, BW, TB,
*      attenuation_dB=ATT, window=filter.firdes.WIN_BLACKMAN_hARRIS)</EM></B>
*
* The theory behind this block can be found in Chapter 7.5 of
* the following book.
*
*   <B><EM>f. harris, "Multirate Signal Processing for Communication
*      Systems", Upper Saddle River, NJ: Prentice Hall, Inc. 2004.</EM></B>
*/
class pfb_arb_resampler_ccf
{
private:
	float        d_acc;               // accumulator; holds fractional part of sample
	unsigned int d_last_filter;       // stores filter for re-entry

public:
	/*!
	 * Creates a kernel to perform arbitrary resampling on a set of samples.
	 *  The number of filters in the filter bank is directly
	 *                    related to quantization noise introduced during the resampling.
	 *                    Defaults to 32 filters.
	 */
	pfb_arb_resampler_ccf();

	~pfb_arb_resampler_ccf();

	/*!
	 * Sets the current phase offset in filterbank.
	 */
	void set_phase(float ph);

	/*!
	 * Gets the current phase of the resampler filterbank.
	 */
	float phase() const;

	/*!
	 * Performs the filter operation that resamples the signal.
	 *
	 * This block takes in a stream of samples and outputs a
	 * resampled and filtered stream. This block should be called
	 * such that the output has \p rate * \p n_to_read amount of
	 * space available in the \p output buffer.
	 */
	int filter(std::complex<float> *out, std::complex<float> *in,
			   int n_to_read);

	void set_acc(float acc);

	float acc();

	float mod(float a, float b);

	std::complex<float> filters(std::complex<float> input[], int j);
	std::complex<float> diff_filters(std::complex<float> input[], int j);
};
